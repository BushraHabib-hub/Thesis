<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-6xl flex flex-col">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Function Details</h1>
        <div class="flex w-full space-x-4">
            <!-- Left Side: JS Function Details -->
            <div class="w-1/2 p-6 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-center">JavaScript Function</h2>
                <div id="functionOutput" class="text-left p-4 bg-gray-200 rounded-lg overflow-auto max-h-96 font-family: monospace"></div>
            </div>
            
            <!-- Right Side: Rust Code Editor -->
            <div class="w-1/2 p-6 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4 text-center">Equivalent Rust Code</h2>
                <textarea id="rustEditor" class="w-full h-96 p-4 border border-gray-300 rounded-lg resize-none" placeholder="Write Rust code here..."></textarea>
            </div>
        </div>
        <button onclick="goBack()" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition self-center w-1/3">Go Back</button>
        <button onclick="compile()" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition self-center w-1/3">Compile</button>
    </div>

    <script>
        // Restore file content and name from sessionStorage if not present
        if (!window.selectedJsFileContent) {
            window.selectedJsFileContent = sessionStorage.getItem('selectedJsFileContent') || "";
        }
        if (!window.selectedJsFileName) {
            window.selectedJsFileName = sessionStorage.getItem('selectedJsFileName') || "";
        }
        console.log("Restored from sessionStorage:", {
            selectedJsFileName: window.selectedJsFileName,
            selectedJsFileContent: window.selectedJsFileContent ? window.selectedJsFileContent.substring(0, 100) + (window.selectedJsFileContent.length > 100 ? "..." : "") : ""
        });

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function loadFunctionDetails() {
            const functionName = getQueryParam("name");
            const functionCode = sessionStorage.getItem(functionName);
            
            if (functionCode) {
                document.getElementById("functionOutput").innerHTML = `
                    <h2 class="text-xl font-bold mb-2">${functionName}</h2>
                    <pre class="bg-gray-300 p-4 rounded-lg overflow-auto">${functionCode.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
                `;
            } else {
                document.getElementById("functionOutput").innerHTML = `<p class="text-red-500">Function not found.</p>`;
            }
        }

        function goBack() {
            window.history.back();
        }

        function compile() {
            const rustCode = document.getElementById("rustEditor").value;
            const functionName = getQueryParam("name");
            // Get the selected JS file content and name from global variable
            const jsFileContent = window.selectedJsFileContent || "";
            const jsFileName = window.selectedJsFileName || "";

            // Show a preview in the console
            const preview = jsFileContent.length > 100 ? jsFileContent.substring(0, 100) + '...' : jsFileContent;
            console.log(`Selected JS file: ${jsFileName}`);
            console.log('JS file preview:', preview);

            if (!rustCode.trim()) {
                alert("Please write some Rust code before compiling.");
                return;
            }            // Log the complete payload for debugging
            const payload = { fname: functionName, wasm: rustCode, jsFileName, jsFileContent };
            console.log('Sending payload to backend:', payload);
            
            fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    // Get the filename from the Content-Disposition header if available
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${functionName}_package.zip`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // Convert the response to a blob
                    return response.blob().then(blob => {
                        // Create a URL for the blob
                        const url = window.URL.createObjectURL(blob);
                        
                        // Create a temporary link element
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        
                        // Append to the document, click it, and remove it
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        alert("Download started for your compiled WASM package");
                    });
                } else {
                    alert("Failed to compile Rust code.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while submitting the Rust code.");
            });
        }

        window.onload = loadFunctionDetails;
    </script>
</body>
</html>
